{% extends "main_template.html" %}

{% block content %}

    <button class="btn btn-grey"><a href="/events/create">Создать событие</a></button>
    <h2>Список событий</h2>

    <button class="last_events">Новые события</button>
    <button class="friends_events">События друзей</button>
    <button class="closest_events">События рядом</button>
    <form class="event_filter_block">
        <select id="" name="category" class="event_filter_category">
            <option value="1">Другое</option>
            <option value="2">Спорт</option>
        </select>
    </form>
    <button class="submit_event_filter">Фильтр</button>
    <div class="content_paginator_events"></div>




    <script>

    /**
     * Проброс токена CSRF во все запросы ajax
     *
     */
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                // Only send the token to relative URLs i.e. locally.
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });


    find_events();

    function find_events() {
        var url = '/main_app/get_infinite_events';
        $.ajax({
            url: url,
            type: 'POST',
            data: get_event_filter('event_filter_block'),
            success: function (data) {
                if (data) {

                    $('.content_paginator_events').html(data);
                    events_waypoints_init(get_event_filter('event_filter_block'));
                } else {
                    // TODO заполнить error
                }
            }
        });
    }



    /**
     * Получение параметров фильтрации для POST запроса
     *
     */
    function get_event_filter(selector) {
        var unindexed_array = $('.'+selector).serializeArray();
        var indexed_array = {};

        $.map(unindexed_array, function(n, i){
            indexed_array[n['name']] = n['value'];
        });
        return indexed_array;
    }

    $('.submit_event_filter').on('click', (e)=>{

        find_events();
    });

    /**
     * Инициализация плагина инфинити скролла, что-то вроде дата тейбла
     *
     */
    function events_waypoints_init(filter) {
        var infinite_ = new Waypoint.Infinite({
            element: $('.content_paginator_events')[0],
            more: '.infinite-more-link',
            items: '.event_item',
            reverse: false,
            post: true,
            filter: filter
        });
        return;
    }





    </script>

{% endblock %}